.. _nuts-documentation-sso:

RFC: Single Sign On (SSO)
#########################


Motivation
**********

Care professionals sometimes work with the same patients for several care
organizations using different software vendors. Their daily work can greatly be
improved when they can share their identity between these software applications.
Therefor we here propose a way of Single-Sign-On (SSO) for sharing a universal
identity among different software applications, not necessary from the same employer.
The method uses most of the techniques already present in a standard Nuts node.

This document builds on Login Contracts and the RFC on Session Tokens.

Status of this RFC
******************

This RFC is a work in progress. See the TODO_ section below. To provide comments
create an issue on the `Github repository containing this documentation
<https://github.com/nuts-foundation/nuts-documentation/issues>`_.

Limitations
***********

A party who wants to verify the identity of the user must run a Nuts Node.

The application the user jumps to can only show patient provided within the session.

The application the user jumps to does not get notified about logout operations
from the original application. Sessions should end after closing the browser window/tab.


Mechanics
*********

We have two applications: The source application, and the destination application.
Both run their own Nuts Node (could be the same node). The source application collects
information about the user and patient, acquires an access token from the destination application.
With this token the user jumps to the destination application.


SSO Steps
=========

#. The User loads a page in a patient context
#. The source application checks rights and settings to see if this user is allows to jump (local policy)
#. The source application checks if the patient has any external care providers with jumpable applications (Nuts registry)
   This requires a local administration of external care providers. The Consent
   store can not be used for this since the patients does not have to give
   consent for a jump.

   #. For each given external care provider, query the Nuts Registry for the Nuts-SSO endpoint.
      The endpoint is described in the :ref:`nuts-registry-api`

#. The source application renders a SSO button
#. The User clicks the button
#. The source application collects the users identity using a login contract. If not already present, it lets the user sign one using IRMA
   To create an IRMA session, make a call to the Nuts Auth server as described in the :ref:`nuts-consent-auth-api`

   .. code-block:: console

     $ curl --location --request POST 'localhost:1323/auth/contract/session' \
      --header 'Content-Type: application/json' \
      --data-raw '{
         "type": "BehandelaarLogin",
         "language": "NL",
         "version": "v1",
         "legalEntity": "Zorggroep Nuts"
      }'

      {"qr_code_info":{"irmaqr":"signing","u":"https://yourdomain.test/auth/irmaclient/session/L6onpBhXyzHnE5bVkipH"},"session_id":"OgU0be4mkKr6bzsArJQr"}

   After the user signs the contract, retrieve the Identity Token:

   .. code-block:: console

     $ curl --location --request GET 'localhost:1323/auth/contract/session/OgU0be4mkKr6bzsArJQr'

     {"disclosed":[{"identifier":"irma-demo.nuts.agb.agbcode","rawvalue":"00000007","status":"PRESENT","value":{"":"00000007","en":"00000007","nl":"00000007"}}],"nuts_auth_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJudXRzIiwibnV0c19zaWduYXR1cmUiOnsiSXJtYUNvbnRyYWN0Ijp7IkBjb250ZXh0IjoiaHR0cHM6Ly9pcm1hLmFwcC9sZC9zaWduYXR1cmUvdjIiLCJjb250ZXh0IjoiQVE9PSIsImluZGljZXMiOltbeyJhdHRyIjoyLCJjcmVkIjowfV1dLCJtZXNzYWdlIjoiTkw6QmVoYW5kZWxhYXJMb2dpbjp2MSBPbmRlcmdldGVrZW5kZSBnZWVmdCB0b2VzdGVtbWluZyBhYW4gRGVtbyBFSFIgb20gbmFtZW5zIFpvcmdncm9lcCBOdXRzIGVuIG9uZGVyZ2V0ZWtlbmRlIGhldCBOdXRzIG5ldHdlcmsgdGUgYmV2cmFnZW4uIERlemUgdG9lc3RlbW1pbmcgaXMgZ2VsZGlnIHZhbiBkaW5zZGFnLCAxMSBmZWJydWFyaSAyMDIwIDA5OjQ5OjI1IHRvdCBkaW5zZGFnLCAxMSBmZWJydWFyaSAyMDIwIDEwOjQ5OjI1LiIsIm5vbmNlIjoid1l3WkRjMjlLRUJYUVU3U3hhdzlBZz09Iiwic2lnbmF0dXJlIjpbeyJBIjoiSUltZEh3QmQzMWdjcTlQM3hHUFo2NEdVYkNsRDBTRmo2eHVkdi9lRjh1MTBiQVRlVmZoUklLUVBMeGI3YXBzWmR6K0RXUlVVMEk1U2VPWnVTblpzZWtSUGc2eW9vQVBZcElSNmgzVTVMTDhzWVFKQ3c5Mk1SUGNaR0l2QW9OL2JJNS9mZUg0dCsrVWhYWHQ5WXVhdmtlcG1jTlYvZE9lK3VDVnNNSVowS2xLelRLekd2Z3ZhQUJpRDFUM2NBZU1VZzdJd3JUMVBIOStOQld0U1B0dzdaUmpSQnhPdmoycFRkT3dXT1dwS2kvVk1qcmxySDczcnQwOW1ZN2JWYmdTMEp2S001TzZlZlJuYytQSHJ6ZnVxMkMwdmNaMHpCTFIyRy9MelNsUnZ1dGx0Z3dKczhuTHVNcEZiVnVCSW5ISVl0ZHhJOStyTzU0ZmxnRk5mOFRLcGVnPT0iLCJhX2Rpc2Nsb3NlZCI6eyIxIjoiQXdBS05nQWFBQUZIMmprbFV0czVpQldTbEtMaE1qdmkiLCIyIjoiWUdCZ1lHQmdZRzg9In0sImFfcmVzcG9uc2VzIjp7IjAiOiJTMmtmWjdveEFCR3Zua1JUVWNYMkFlRmZlTjlqbUV4citlWXdkTzdxL2R6czZOZEs0NHk3SDhzUHZiWW5TeFE1VElCb1lrOGo2QXMwbitKMnZKWkI3U3Foa0ZOV2dyOGNESUU9IiwiMyI6IlJia29KbnA3cHVTM2xiQXgzVUV1aUM0NnU5aTdseFI4M3lZOEE5LzBjWU9LSnNxU1liNmh6cnpRRmpCMWlQSEdQS2lQRlArcCtwTzZmMXh2YTVZNEh0Nm1JSk5rNmRURnhrZksvN3pQVVBnPSJ9LCJjIjoib3NCQjdzYWJ3SVA1UnNUQWcrZGpJL3ZMYmFyNHE2dE1sa1huTWRsVmFrZz0iLCJlX3Jlc3BvbnNlIjoicTVuOW5QbkdkMzVQb3FocFlKa1NqUEdWOG1OL3FvMEhSVUxEWUFubkdBelVoRUYzaVhDempENW5Mc0NDNURnY0Fldjd6SEo4WGtWeG9FeFNTZEJkIiwidl9yZXNwb25zZSI6IkJjMDdjR0FvbFVzdURnMGEwKzFOaG5obXRBZFpMOElaby84bWNqVUNlanh6RGFjVEx1bEk3TEFvbytrdzRJTDJSVG40QkoxdGdkUTlEWHhPYXoxMDluVzBqUURUdEJCS2tacERVVzBMVmdYNExlR0NhVmF4N3N4VXd1aFhhT01JWlZFVmhTd25DRExncmd2RHhabEpaSDFTYjRaUHY3aUhPWlZNY0dJUjd5QjgyTGpXa3NIVi80amw4UjIxNlA4MmZmSTlmaTZ6amJrYld4M3RFN2ZoZGpxaVNGdS83UTRVSXBvODJCTVhZRHEvOENKaHBjb0d2WGg3VlVCaDdHc1RTWm9IWThDcTRpeE1ndnYyZDllbmwwZGZrTVh4aWNKTFdCZHZYV0xlYTl3c1RhR3FKa3B5TkhURE5aVGE1QW54bXEyTmZhTXhHM0JTNHJoL01sS0p4VmJKQ21LNlh3cHMzUnlqZC9MaDVLYURidFZBREdLaDUrNmdrKy84Z3hKTDRuQ0tkRTBTZW5NZkp1a09QUjYyT1A3N0RnWkxuOWxIYlM3Sk1rWURwRVNXQU9hRWNsZnVaRlU2M1VOYm5oZUhQOGVOMTZCRy92MDVyU0tINVROamxTUmY3MXRaOVZjblpybU8yR3cybzRvVDlFd3orbWx4aDhoTTZITTZvRWc2Q0ZqUWIzZGFBUzRnbTBMR2ZIRjZ2ejg9In1dLCJ0aW1lc3RhbXAiOnsiU2VydmVyVXJsIjoiaHR0cHM6Ly9rZXlzaGFyZS5wcml2YWN5YnlkZXNpZ24uZm91bmRhdGlvbi9hdHVtZC8iLCJTaWciOnsiQWxnIjoiZWQyNTUxOSIsIkRhdGEiOiJCdnRFOW5TMSs3dmcyVlpCQ3dQd2NsemJMbUVTUVI0WFA2ektoQ211QUZJWlJhZGRGUGR6ODFUejZaajZTQUhjUmk1N3JRNlYzSmc5b3djeE43RUFCUT09IiwiUHVibGljS2V5IjoiTUtkWHhKeEVXUFJJd05QN1N1dlAwSi9NL05WNTFWWnZxQ3lPKzdlRHdKOD0ifSwiVGltZSI6MTU4MTQxMDk4NX19fSwic3ViIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4xOjAwMDAwMDAwIn0.Sj7KqJDSYSD6Wjl48B-guNQoJNwpi-I9oy7JD4fhyUvYfvapLr2tCyxg5auY48h9Iwz3j2E71kQ242Nj7VgINqC94aUFpBBp79v9aDC3p-Sbr3RCZ2aiXGAmxhN8xerR0ETedhAeNZxFNLjkBlXhDxNHcDji11B_5mkQjTmymg_30x1CGQlJfXa_l31TPoSrPWGVxu3wWYKThTK1tpRzC_f9aTVHEvpFgqGLAgzY2BMNY7VwqXXMyRfrAAe2n8foiSA8lSVAa47CJWx0-4svWadcPBkwp1DgwxLoMKDceNy2ZY12kWYpHtwVgUdLq6Y7nv_As66ui0f06yMhTtRlEQ","proofStatus":"VALID","status":"DONE","token":"OgU0be4mkKr6bzsArJQr","type":"signing"}


#. Construct a JWT Bearer token by submitting the Custodian, Actor, subject and Identity Token to the jwtbearertoken endpoint:

   .. code-block:: console

      $ curl --location --request POST 'localhost:1323/auth/jwtbearertoken' \
       --header 'Content-Type: application/json' \
       --data-raw '{
         "custodian": "urn:oid:2.16.840.1.113883.2.4.6.1:00000001",
         "actor": "urn:oid:2.16.840.1.113883.2.4.6.1:00000000",
         "subject": "urn:oid:2.16.840.1.113883.2.4.6.3:999999990",
         "identity": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJudXRzIiwibnV0c19zaWduYXR1cmUiOnsiSXJtYUNvbnRyYWN0Ijp7IkBjb250ZXh0IjoiaHR0cHM6Ly9pcm1hLmFwcC9sZC9zaWduYXR1cmUvdjIiLCJjb250ZXh0IjoiQVE9PSIsImluZGljZXMiOltbeyJhdHRyIjoyLCJjcmVkIjowfV1dLCJtZXNzYWdlIjoiTkw6QmVoYW5kZWxhYXJMb2dpbjp2MSBPbmRlcmdldGVrZW5kZSBnZWVmdCB0b2VzdGVtbWluZyBhYW4gRGVtbyBFSFIgb20gbmFtZW5zIFpvcmdncm9lcCBOdXRzIGVuIG9uZGVyZ2V0ZWtlbmRlIGhldCBOdXRzIG5ldHdlcmsgdGUgYmV2cmFnZW4uIERlemUgdG9lc3RlbW1pbmcgaXMgZ2VsZGlnIHZhbiBkaW5zZGFnLCAxMSBmZWJydWFyaSAyMDIwIDA5OjQ5OjI1IHRvdCBkaW5zZGFnLCAxMSBmZWJydWFyaSAyMDIwIDEwOjQ5OjI1LiIsIm5vbmNlIjoid1l3WkRjMjlLRUJYUVU3U3hhdzlBZz09Iiwic2lnbmF0dXJlIjpbeyJBIjoiSUltZEh3QmQzMWdjcTlQM3hHUFo2NEdVYkNsRDBTRmo2eHVkdi9lRjh1MTBiQVRlVmZoUklLUVBMeGI3YXBzWmR6K0RXUlVVMEk1U2VPWnVTblpzZWtSUGc2eW9vQVBZcElSNmgzVTVMTDhzWVFKQ3c5Mk1SUGNaR0l2QW9OL2JJNS9mZUg0dCsrVWhYWHQ5WXVhdmtlcG1jTlYvZE9lK3VDVnNNSVowS2xLelRLekd2Z3ZhQUJpRDFUM2NBZU1VZzdJd3JUMVBIOStOQld0U1B0dzdaUmpSQnhPdmoycFRkT3dXT1dwS2kvVk1qcmxySDczcnQwOW1ZN2JWYmdTMEp2S001TzZlZlJuYytQSHJ6ZnVxMkMwdmNaMHpCTFIyRy9MelNsUnZ1dGx0Z3dKczhuTHVNcEZiVnVCSW5ISVl0ZHhJOStyTzU0ZmxnRk5mOFRLcGVnPT0iLCJhX2Rpc2Nsb3NlZCI6eyIxIjoiQXdBS05nQWFBQUZIMmprbFV0czVpQldTbEtMaE1qdmkiLCIyIjoiWUdCZ1lHQmdZRzg9In0sImFfcmVzcG9uc2VzIjp7IjAiOiJTMmtmWjdveEFCR3Zua1JUVWNYMkFlRmZlTjlqbUV4citlWXdkTzdxL2R6czZOZEs0NHk3SDhzUHZiWW5TeFE1VElCb1lrOGo2QXMwbitKMnZKWkI3U3Foa0ZOV2dyOGNESUU9IiwiMyI6IlJia29KbnA3cHVTM2xiQXgzVUV1aUM0NnU5aTdseFI4M3lZOEE5LzBjWU9LSnNxU1liNmh6cnpRRmpCMWlQSEdQS2lQRlArcCtwTzZmMXh2YTVZNEh0Nm1JSk5rNmRURnhrZksvN3pQVVBnPSJ9LCJjIjoib3NCQjdzYWJ3SVA1UnNUQWcrZGpJL3ZMYmFyNHE2dE1sa1huTWRsVmFrZz0iLCJlX3Jlc3BvbnNlIjoicTVuOW5QbkdkMzVQb3FocFlKa1NqUEdWOG1OL3FvMEhSVUxEWUFubkdBelVoRUYzaVhDempENW5Mc0NDNURnY0Fldjd6SEo4WGtWeG9FeFNTZEJkIiwidl9yZXNwb25zZSI6IkJjMDdjR0FvbFVzdURnMGEwKzFOaG5obXRBZFpMOElaby84bWNqVUNlanh6RGFjVEx1bEk3TEFvbytrdzRJTDJSVG40QkoxdGdkUTlEWHhPYXoxMDluVzBqUURUdEJCS2tacERVVzBMVmdYNExlR0NhVmF4N3N4VXd1aFhhT01JWlZFVmhTd25DRExncmd2RHhabEpaSDFTYjRaUHY3aUhPWlZNY0dJUjd5QjgyTGpXa3NIVi80amw4UjIxNlA4MmZmSTlmaTZ6amJrYld4M3RFN2ZoZGpxaVNGdS83UTRVSXBvODJCTVhZRHEvOENKaHBjb0d2WGg3VlVCaDdHc1RTWm9IWThDcTRpeE1ndnYyZDllbmwwZGZrTVh4aWNKTFdCZHZYV0xlYTl3c1RhR3FKa3B5TkhURE5aVGE1QW54bXEyTmZhTXhHM0JTNHJoL01sS0p4VmJKQ21LNlh3cHMzUnlqZC9MaDVLYURidFZBREdLaDUrNmdrKy84Z3hKTDRuQ0tkRTBTZW5NZkp1a09QUjYyT1A3N0RnWkxuOWxIYlM3Sk1rWURwRVNXQU9hRWNsZnVaRlU2M1VOYm5oZUhQOGVOMTZCRy92MDVyU0tINVROamxTUmY3MXRaOVZjblpybU8yR3cybzRvVDlFd3orbWx4aDhoTTZITTZvRWc2Q0ZqUWIzZGFBUzRnbTBMR2ZIRjZ2ejg9In1dLCJ0aW1lc3RhbXAiOnsiU2VydmVyVXJsIjoiaHR0cHM6Ly9rZXlzaGFyZS5wcml2YWN5YnlkZXNpZ24uZm91bmRhdGlvbi9hdHVtZC8iLCJTaWciOnsiQWxnIjoiZWQyNTUxOSIsIkRhdGEiOiJCdnRFOW5TMSs3dmcyVlpCQ3dQd2NsemJMbUVTUVI0WFA2ektoQ211QUZJWlJhZGRGUGR6ODFUejZaajZTQUhjUmk1N3JRNlYzSmc5b3djeE43RUFCUT09IiwiUHVibGljS2V5IjoiTUtkWHhKeEVXUFJJd05QN1N1dlAwSi9NL05WNTFWWnZxQ3lPKzdlRHdKOD0ifSwiVGltZSI6MTU4MTQxMDk4NX19fSwic3ViIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4xOjAwMDAwMDAwIn0.Sj7KqJDSYSD6Wjl48B-guNQoJNwpi-I9oy7JD4fhyUvYfvapLr2tCyxg5auY48h9Iwz3j2E71kQ242Nj7VgINqC94aUFpBBp79v9aDC3p-Sbr3RCZ2aiXGAmxhN8xerR0ETedhAeNZxFNLjkBlXhDxNHcDji11B_5mkQjTmymg_30x1CGQlJfXa_l31TPoSrPWGVxu3wWYKThTK1tpRzC_f9aTVHEvpFgqGLAgzY2BMNY7VwqXXMyRfrAAe2n8foiSA8lSVAa47CJWx0-4svWadcPBkwp1DgwxLoMKDceNy2ZY12kWYpHtwVgUdLq6Y7nv_As66ui0f06yMhTtRlEQ"
       }'

       {"bearer_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJodHRwczovL3RhcmdldF90b2tlbl9lbmRwb2ludCIsImV4cCI6MTU4MTQxMzQwMiwiaWF0IjoxNTgxNDExNjAyLCJpc3MiOiJ1cm46b2lkOjIuMTYuODQwLjEuMTEzODgzLjIuNC42LjE6MDAwMDAwMDAiLCJqdGkiOiI1ZGQyMTY4Zi04MmZmLTQ0OTgtOGU3Mi0zOGJlMmRlMTFlNzciLCJzaWQiOiJ1cm46b2lkOjIuMTYuODQwLjEuMTEzODgzLjIuNC42LjM6OTk5OTk5OTkwIiwic3ViIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4xOjAwMDAwMDAxIiwidXNpIjoiZXlKaGJHY2lPaUpTVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKdWRYUnpJaXdpYm5WMGMxOXphV2R1WVhSMWNtVWlPbnNpU1hKdFlVTnZiblJ5WVdOMElqcDdJa0JqYjI1MFpYaDBJam9pYUhSMGNITTZMeTlwY20xaExtRndjQzlzWkM5emFXZHVZWFIxY21VdmRqSWlMQ0pqYjI1MFpYaDBJam9pUVZFOVBTSXNJbWx1WkdsalpYTWlPbHRiZXlKaGRIUnlJam95TENKamNtVmtJam93ZlYxZExDSnRaWE56WVdkbElqb2lUa3c2UW1Wb1lXNWtaV3hoWVhKTWIyZHBianAyTVNCUGJtUmxjbWRsZEdWclpXNWtaU0JuWldWbWRDQjBiMlZ6ZEdWdGJXbHVaeUJoWVc0Z1JHVnRieUJGU0ZJZ2IyMGdibUZ0Wlc1eklGcHZjbWRuY205bGNDQk9kWFJ6SUdWdUlHOXVaR1Z5WjJWMFpXdGxibVJsSUdobGRDQk9kWFJ6SUc1bGRIZGxjbXNnZEdVZ1ltVjJjbUZuWlc0dUlFUmxlbVVnZEc5bGMzUmxiVzFwYm1jZ2FYTWdaMlZzWkdsbklIWmhiaUJrYVc1elpHRm5MQ0F4TVNCbVpXSnlkV0Z5YVNBeU1ESXdJREE1T2pRNU9qSTFJSFJ2ZENCa2FXNXpaR0ZuTENBeE1TQm1aV0p5ZFdGeWFTQXlNREl3SURFd09qUTVPakkxTGlJc0ltNXZibU5sSWpvaWQxbDNXa1JqTWpsTFJVSllVVlUzVTNoaGR6bEJaejA5SWl3aWMybG5ibUYwZFhKbElqcGJleUpCSWpvaVNVbHRaRWgzUW1Rek1XZGpjVGxRTTNoSFVGbzJORWRWWWtOc1JEQlRSbW8yZUhWa2RpOWxSamgxTVRCaVFWUmxWbVpvVWtsTFVWQk1lR0kzWVhCeldtUjZLMFJYVWxWVk1FazFVMlZQV25WVGJscHpaV3RTVUdjMmVXOXZRVkJaY0VsU05tZ3pWVFZNVERoeldWRktRM2M1TWsxU1VHTmFSMGwyUVc5T0wySkpOUzltWlVnMGRDc3JWV2hZV0hRNVdYVmhkbXRsY0cxalRsWXZaRTlsSzNWRFZuTk5TVm93UzJ4TGVsUkxla2QyWjNaaFFVSnBSREZVTTJOQlpVMVZaemRKZDNKVU1WQklPU3RPUWxkMFUxQjBkemRhVW1wU1FuaFBkbW95Y0ZSa1QzZFhUMWR3UzJrdlZrMXFjbXh5U0RjemNuUXdPVzFaTjJKV1ltZFRNRXAyUzAwMVR6WmxabEp1WXl0UVNISjZablZ4TWtNd2RtTmFNSHBDVEZJeVJ5OU1lbE5zVW5aMWRHeDBaM2RLY3podVRIVk5jRVppVm5WQ1NXNUlTVmwwWkhoSk9TdHlUelUwWm14blJrNW1PRlJMY0dWblBUMGlMQ0poWDJScGMyTnNiM05sWkNJNmV5SXhJam9pUVhkQlMwNW5RV0ZCUVVaSU1tcHJiRlYwY3pWcFFsZFRiRXRNYUUxcWRta2lMQ0l5SWpvaVdVZENaMWxIUW1kWlJ6ZzlJbjBzSW1GZmNtVnpjRzl1YzJWeklqcDdJakFpT2lKVE1tdG1XamR2ZUVGQ1IzWnVhMUpVVldOWU1rRmxSbVpsVGpscWJVVjRjaXRsV1hka1R6ZHhMMlI2Y3paT1pFczBOSGszU0RoelVIWmlXVzVUZUZFMVZFbENiMWxyT0dvMlFYTXdiaXRLTW5aS1drSTNVM0ZvYTBaT1YyZHlPR05FU1VVOUlpd2lNeUk2SWxKaWEyOUtibkEzY0hWVE0yeGlRWGd6VlVWMWFVTTBOblU1YVRkc2VGSTRNM2xaT0VFNUx6QmpXVTlMU25OeFUxbGlObWg2Y25wUlJtcENNV2xRU0VkUVMybFFSbEFyY0N0d1R6Wm1NWGgyWVRWWk5FaDBObTFKU2s1ck5tUlVSbmhyWmtzdk4zcFFWVkJuUFNKOUxDSmpJam9pYjNOQ1FqZHpZV0ozU1ZBMVVuTlVRV2NyWkdwSkwzWk1ZbUZ5TkhFMmRFMXNhMWh1VFdSc1ZtRnJaejBpTENKbFgzSmxjM0J2Ym5ObElqb2ljVFZ1T1c1UWJrZGtNelZRYjNGb2NGbEthMU5xVUVkV09HMU9MM0Z2TUVoU1ZVeEVXVUZ1YmtkQmVsVm9SVVl6YVZoRGVtcEVOVzVNYzBORE5VUm5ZMEZsZGpkNlNFbzRXR3RXZUc5RmVGTlRaRUprSWl3aWRsOXlaWE53YjI1elpTSTZJa0pqTURkalIwRnZiRlZ6ZFVSbk1HRXdLekZPYUc1b2JYUkJaRnBNT0VsYWJ5ODRiV05xVlVObGFuaDZSR0ZqVkV4MWJFazNURUZ2Ynl0cmR6UkpUREpTVkc0MFFrb3hkR2RrVVRsRVdIaFBZWG94TURsdVZ6QnFVVVJVZEVKQ1MydGFjRVJWVnpCTVZtZFlORXhsUjBOaFZtRjROM040VlhkMWFGaGhUMDFKV2xaRlZtaFRkMjVEUkV4bmNtZDJSSGhhYkVwYVNERlRZalJhVUhZM2FVaFBXbFpOWTBkSlVqZDVRamd5VEdwWGEzTklWaTgwYW13NFVqSXhObEE0TW1abVNUbG1hVFo2YW1KcllsZDRNM1JGTjJab1pHcHhhVk5HZFM4M1VUUlZTWEJ2T0RKQ1RWaFpSSEV2T0VOS2FIQmpiMGQyV0dnM1ZsVkNhRGRIYzFSVFdtOUlXVGhEY1RScGVFMW5kbll5WkRsbGJtd3daR1pyVFZoNGFXTktURmRDWkhaWVYweGxZVGwzYzFSaFIzRkthM0I1VGtoVVJFNWFWR0UxUVc1NGJYRXlUbVpoVFhoSE0wSlROSEpvTDAxc1MwcDRWbUpLUTIxTE5saDNjSE16VW5scVpDOU1hRFZMWVVSaWRGWkJSRWRMYURVck5tZHJLeTg0WjNoS1REUnVRMHRrUlRCVFpXNU5aa3AxYTA5UVVqWXlUMUEzTjBSbldreHVPV3hJWWxNM1NrMXJXVVJ3UlZOWFFVOWhSV05zWm5WYVJsVTJNMVZPWW01b1pVaFFPR1ZPTVRaQ1J5OTJNRFZ5VTB0SU5WUk9hbXhUVW1ZM01YUmFPVlpqYmxweWJVOHlSM2N5YnpSdlZEbEZkM29yYld4NGFEaG9UVFpJVFRadlJXYzJRMFpxVVdJelpHRkJVelJuYlRCTVIyWklSaloyZWpnOUluMWRMQ0owYVcxbGMzUmhiWEFpT25zaVUyVnlkbVZ5VlhKc0lqb2lhSFIwY0hNNkx5OXJaWGx6YUdGeVpTNXdjbWwyWVdONVlubGtaWE5wWjI0dVptOTFibVJoZEdsdmJpOWhkSFZ0WkM4aUxDSlRhV2NpT25zaVFXeG5Jam9pWldReU5UVXhPU0lzSWtSaGRHRWlPaUpDZG5SRk9XNVRNU3MzZG1jeVZscENRM2RRZDJOc2VtSk1iVVZUVVZJMFdGQTJla3RvUTIxMVFVWkpXbEpoWkdSR1VHUjZPREZVZWpaYWFqWlRRVWhqVW1rMU4zSlJObFl6U21jNWIzZGplRTQzUlVGQ1VUMDlJaXdpVUhWaWJHbGpTMlY1SWpvaVRVdGtXSGhLZUVWWFVGSkpkMDVRTjFOMWRsQXdTaTlOTDA1V05URldXblp4UTNsUEt6ZGxSSGRLT0QwaWZTd2lWR2x0WlNJNk1UVTRNVFF4TURrNE5YMTlmU3dpYzNWaUlqb2lkWEp1T205cFpEb3lMakUyTGpnME1DNHhMakV4TXpnNE15NHlMalF1Tmk0eE9qQXdNREF3TURBd0luMC5TajdLcUpEU1lTRDZXamw0OEItZ3VOUW9KTndwaS1JOW95N0pENGZoeVV2WWZ2YXBMcjJ0Q3l4ZzVhdVk0OGg5SXd6M2oyRTcxa1EyNDJOajdWZ0lOcUM5NGFVRnBCQnA3OXY5YURDM3AtU2JyM1JDWjJhaVhHQW14aE44eGVyUjBFVGVkaEFlTlp4Rk5MamtCbFhoRHhOSGNEamkxMUJfNW1rUWpUbXltZ18zMHgxQ0dRbEpmWGFfbDMxVFBvU3JQV0dWeHUzd1dZS1RoVEsxdHBSekNfZjlhVFZIRXZwRmdxR0xBZ3pZMkJNTlk3VndxWFhNeVJmckFBZTJuOGZvaVNBOGxTVkFhNDdDSld4MC00c3ZXYWRjUEJrd3AxRGd3eExvTUtEY2VOeTJaWTEya1dZcEh0d1ZnVWRMcTZZN252X0FzNjZ1aTBmMDZ5TWhUdFJsRVEifQ.TF8lmmSQ4WkznMXLmh6JTA0cYwSrKoKd_yK7jKzweyAZhIGv9tmxGASZ7cIg9495U9SsyGVSQUpvY0gMIYLIRENzUJ1rUCS1kYSDrIvp13DRwGrz74f7SAp8hQXer1R4wgn9OfZ5Skx-A9bSaoWoko8IIV-Tvo1XMHLhqV-msQig5Q-IFoYtsBkdhdDBSaDEy9-LJcjK5eU0Ymc781KRz5usdz3ta6QMfqfg_Ypx2NuID5bJg0Mcnw6nooMreQl7lgO_clyJGfUdS0v2A7pCXi6Vc2c9zRxdNKJSLd65odDrvfhcHGNlaGZrMn07phmT13YR0e4rBAV1tkapERp23Q"}

#. The source application requests a session token providing the JWT Bearer token
   This is described in the :ref:`nuts-documentation-session-tokens`

   .. code-block:: console

     $ curl --location --request GET 'localhost:1323/api/endpoints?orgIds=urn:oid:2.16.840.1.113883.2.4.6.1:00000001&type=urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-oauth-authentication-server'

     [
         {
             "URL": "https://nuts.custodian.test",
             "endpointType": "urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-oauth-authentication-server",
             "identifier": "63dda892-7d4d-4059-b3be-b73c9136e385",
             "status": "active",
             "version": "0.1.0"
         }
     ]

     $ curl --location --request POST 'https://nuts.custodian.test/auth/accesstoken' \
      --header 'Content-Type: application/x-www-form-urlencoded' \
      --data-urlencode 'grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer' \
      --data-urlencode 'assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJodHRwczovL3RhcmdldF90b2tlbl9lbmRwb2ludCIsImV4cCI6MTU4MTQxMzI1NywiaWF0IjoxNTgxNDExNDU3LCJpc3MiOiJ1cm46b2lkOjIuMTYuODQwLjEuMTEzODgzLjIuNC42LjE6MDAwMDAwMDAiLCJqdGkiOiIwYzllNDQyYS05MjNlLTRiZjgtOWI4Ni1mZjllZDgyYTkyMjkiLCJzaWQiOiJ1cm46b2lkOjIuMTYuODQwLjEuMTEzODgzLjIuNC42LjM6OTk5OTk5OTkwIiwic3ViIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4xOjAwMDAwMDAxIiwidXNpIjoiZXlKaGJHY2lPaUpTVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKdWRYUnpJaXdpYm5WMGMxOXphV2R1WVhSMWNtVWlPbnNpU1hKdFlVTnZiblJ5WVdOMElqcDdJa0JqYjI1MFpYaDBJam9pYUhSMGNITTZMeTlwY20xaExtRndjQzlzWkM5emFXZHVZWFIxY21VdmRqSWlMQ0pqYjI1MFpYaDBJam9pUVZFOVBTSXNJbWx1WkdsalpYTWlPbHRiZXlKaGRIUnlJam95TENKamNtVmtJam93ZlYxZExDSnRaWE56WVdkbElqb2lUa3c2UW1Wb1lXNWtaV3hoWVhKTWIyZHBianAyTVNCUGJtUmxjbWRsZEdWclpXNWtaU0JuWldWbWRDQjBiMlZ6ZEdWdGJXbHVaeUJoWVc0Z1JHVnRieUJGU0ZJZ2IyMGdibUZ0Wlc1eklGcHZjbWRuY205bGNDQk9kWFJ6SUdWdUlHOXVaR1Z5WjJWMFpXdGxibVJsSUdobGRDQk9kWFJ6SUc1bGRIZGxjbXNnZEdVZ1ltVjJjbUZuWlc0dUlFUmxlbVVnZEc5bGMzUmxiVzFwYm1jZ2FYTWdaMlZzWkdsbklIWmhiaUJrYVc1elpHRm5MQ0F4TVNCbVpXSnlkV0Z5YVNBeU1ESXdJREE1T2pRNU9qSTFJSFJ2ZENCa2FXNXpaR0ZuTENBeE1TQm1aV0p5ZFdGeWFTQXlNREl3SURFd09qUTVPakkxTGlJc0ltNXZibU5sSWpvaWQxbDNXa1JqTWpsTFJVSllVVlUzVTNoaGR6bEJaejA5SWl3aWMybG5ibUYwZFhKbElqcGJleUpCSWpvaVNVbHRaRWgzUW1Rek1XZGpjVGxRTTNoSFVGbzJORWRWWWtOc1JEQlRSbW8yZUhWa2RpOWxSamgxTVRCaVFWUmxWbVpvVWtsTFVWQk1lR0kzWVhCeldtUjZLMFJYVWxWVk1FazFVMlZQV25WVGJscHpaV3RTVUdjMmVXOXZRVkJaY0VsU05tZ3pWVFZNVERoeldWRktRM2M1TWsxU1VHTmFSMGwyUVc5T0wySkpOUzltWlVnMGRDc3JWV2hZV0hRNVdYVmhkbXRsY0cxalRsWXZaRTlsSzNWRFZuTk5TVm93UzJ4TGVsUkxla2QyWjNaaFFVSnBSREZVTTJOQlpVMVZaemRKZDNKVU1WQklPU3RPUWxkMFUxQjBkemRhVW1wU1FuaFBkbW95Y0ZSa1QzZFhUMWR3UzJrdlZrMXFjbXh5U0RjemNuUXdPVzFaTjJKV1ltZFRNRXAyUzAwMVR6WmxabEp1WXl0UVNISjZablZ4TWtNd2RtTmFNSHBDVEZJeVJ5OU1lbE5zVW5aMWRHeDBaM2RLY3podVRIVk5jRVppVm5WQ1NXNUlTVmwwWkhoSk9TdHlUelUwWm14blJrNW1PRlJMY0dWblBUMGlMQ0poWDJScGMyTnNiM05sWkNJNmV5SXhJam9pUVhkQlMwNW5RV0ZCUVVaSU1tcHJiRlYwY3pWcFFsZFRiRXRNYUUxcWRta2lMQ0l5SWpvaVdVZENaMWxIUW1kWlJ6ZzlJbjBzSW1GZmNtVnpjRzl1YzJWeklqcDdJakFpT2lKVE1tdG1XamR2ZUVGQ1IzWnVhMUpVVldOWU1rRmxSbVpsVGpscWJVVjRjaXRsV1hka1R6ZHhMMlI2Y3paT1pFczBOSGszU0RoelVIWmlXVzVUZUZFMVZFbENiMWxyT0dvMlFYTXdiaXRLTW5aS1drSTNVM0ZvYTBaT1YyZHlPR05FU1VVOUlpd2lNeUk2SWxKaWEyOUtibkEzY0hWVE0yeGlRWGd6VlVWMWFVTTBOblU1YVRkc2VGSTRNM2xaT0VFNUx6QmpXVTlMU25OeFUxbGlObWg2Y25wUlJtcENNV2xRU0VkUVMybFFSbEFyY0N0d1R6Wm1NWGgyWVRWWk5FaDBObTFKU2s1ck5tUlVSbmhyWmtzdk4zcFFWVkJuUFNKOUxDSmpJam9pYjNOQ1FqZHpZV0ozU1ZBMVVuTlVRV2NyWkdwSkwzWk1ZbUZ5TkhFMmRFMXNhMWh1VFdSc1ZtRnJaejBpTENKbFgzSmxjM0J2Ym5ObElqb2ljVFZ1T1c1UWJrZGtNelZRYjNGb2NGbEthMU5xVUVkV09HMU9MM0Z2TUVoU1ZVeEVXVUZ1YmtkQmVsVm9SVVl6YVZoRGVtcEVOVzVNYzBORE5VUm5ZMEZsZGpkNlNFbzRXR3RXZUc5RmVGTlRaRUprSWl3aWRsOXlaWE53YjI1elpTSTZJa0pqTURkalIwRnZiRlZ6ZFVSbk1HRXdLekZPYUc1b2JYUkJaRnBNT0VsYWJ5ODRiV05xVlVObGFuaDZSR0ZqVkV4MWJFazNURUZ2Ynl0cmR6UkpUREpTVkc0MFFrb3hkR2RrVVRsRVdIaFBZWG94TURsdVZ6QnFVVVJVZEVKQ1MydGFjRVJWVnpCTVZtZFlORXhsUjBOaFZtRjROM040VlhkMWFGaGhUMDFKV2xaRlZtaFRkMjVEUkV4bmNtZDJSSGhhYkVwYVNERlRZalJhVUhZM2FVaFBXbFpOWTBkSlVqZDVRamd5VEdwWGEzTklWaTgwYW13NFVqSXhObEE0TW1abVNUbG1hVFo2YW1KcllsZDRNM1JGTjJab1pHcHhhVk5HZFM4M1VUUlZTWEJ2T0RKQ1RWaFpSSEV2T0VOS2FIQmpiMGQyV0dnM1ZsVkNhRGRIYzFSVFdtOUlXVGhEY1RScGVFMW5kbll5WkRsbGJtd3daR1pyVFZoNGFXTktURmRDWkhaWVYweGxZVGwzYzFSaFIzRkthM0I1VGtoVVJFNWFWR0UxUVc1NGJYRXlUbVpoVFhoSE0wSlROSEpvTDAxc1MwcDRWbUpLUTIxTE5saDNjSE16VW5scVpDOU1hRFZMWVVSaWRGWkJSRWRMYURVck5tZHJLeTg0WjNoS1REUnVRMHRrUlRCVFpXNU5aa3AxYTA5UVVqWXlUMUEzTjBSbldreHVPV3hJWWxNM1NrMXJXVVJ3UlZOWFFVOWhSV05zWm5WYVJsVTJNMVZPWW01b1pVaFFPR1ZPTVRaQ1J5OTJNRFZ5VTB0SU5WUk9hbXhUVW1ZM01YUmFPVlpqYmxweWJVOHlSM2N5YnpSdlZEbEZkM29yYld4NGFEaG9UVFpJVFRadlJXYzJRMFpxVVdJelpHRkJVelJuYlRCTVIyWklSaloyZWpnOUluMWRMQ0owYVcxbGMzUmhiWEFpT25zaVUyVnlkbVZ5VlhKc0lqb2lhSFIwY0hNNkx5OXJaWGx6YUdGeVpTNXdjbWwyWVdONVlubGtaWE5wWjI0dVptOTFibVJoZEdsdmJpOWhkSFZ0WkM4aUxDSlRhV2NpT25zaVFXeG5Jam9pWldReU5UVXhPU0lzSWtSaGRHRWlPaUpDZG5SRk9XNVRNU3MzZG1jeVZscENRM2RRZDJOc2VtSk1iVVZUVVZJMFdGQTJla3RvUTIxMVFVWkpXbEpoWkdSR1VHUjZPREZVZWpaYWFqWlRRVWhqVW1rMU4zSlJObFl6U21jNWIzZGplRTQzUlVGQ1VUMDlJaXdpVUhWaWJHbGpTMlY1SWpvaVRVdGtXSGhLZUVWWFVGSkpkMDVRTjFOMWRsQXdTaTlOTDA1V05URldXblp4UTNsUEt6ZGxSSGRLT0QwaWZTd2lWR2x0WlNJNk1UVTRNVFF4TURrNE5YMTlmU3dpYzNWaUlqb2lkWEp1T205cFpEb3lMakUyTGpnME1DNHhMakV4TXpnNE15NHlMalF1Tmk0eE9qQXdNREF3TURBd0luMC5TajdLcUpEU1lTRDZXamw0OEItZ3VOUW9KTndwaS1JOW95N0pENGZoeVV2WWZ2YXBMcjJ0Q3l4ZzVhdVk0OGg5SXd6M2oyRTcxa1EyNDJOajdWZ0lOcUM5NGFVRnBCQnA3OXY5YURDM3AtU2JyM1JDWjJhaVhHQW14aE44eGVyUjBFVGVkaEFlTlp4Rk5MamtCbFhoRHhOSGNEamkxMUJfNW1rUWpUbXltZ18zMHgxQ0dRbEpmWGFfbDMxVFBvU3JQV0dWeHUzd1dZS1RoVEsxdHBSekNfZjlhVFZIRXZwRmdxR0xBZ3pZMkJNTlk3VndxWFhNeVJmckFBZTJuOGZvaVNBOGxTVkFhNDdDSld4MC00c3ZXYWRjUEJrd3AxRGd3eExvTUtEY2VOeTJaWTEya1dZcEh0d1ZnVWRMcTZZN252X0FzNjZ1aTBmMDZ5TWhUdFJsRVEifQ.vGo9NlinWQi9IGFFNUYHcrBzf9oFkNjE71_uEdeyX_wKmqT0bUj99wTuKp2BPaDZ6leRx9zIGYTu5Vu6ZgcJkrDiX8SpSYoVvPKdpH8HSUXrTCX3a5_LQKVvS4Saw7nFte_U6QEiE2DZyklQlfUasDPQdiEPEppLd9l3g6Nve04wwbI1Md5MXQDkXaqDRzfD6R9KZn0XeNFPoEnvfITRX-l0_3YhwRt11Ey15IGlNsCh6c9BlxytCL4rscgORrGsjY4-6biW7srBAl2tKzXv7qMw_Tqaq2HR-BpXi7d9Ur7vusSRYO6cg4M_0YG6JaqWfJzJcVzX6ZSuwhLcb2chJA'

      {"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhaWQiOiJ1cm46b2lkOjIuMTYuODQwLjEuMTEzODgzLjIuNC42LjE6MDAwMDAwMDAiLCJleHAiOjE1ODE0MTI2NjcsImlhdCI6MTU4MTQxMTc2NywiaXNzIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4xOjAwMDAwMDAxIiwic2lkIjoidXJuOm9pZDoyLjE2Ljg0MC4xLjExMzg4My4yLjQuNi4zOjk5OTk5OTk5MCIsInN1YiI6IiJ9.OhniTJcPS45nhJVqXfxsngG5eYS_0BvqFg-96zaWFO90I_5_N9Eg_k7NmIF5eNZ9Xutl1aqSxlSp80EX07Gmk8uzZO9PEReo0YZxnNQV-Zeq1njCMmfdwusmiczFlwcBi5Bl1xYGmLrxP7NcAoljmDgMgmLH0xaKfP4VVim6snPkPHqBdSzAgSrrc-cgVDLl-9V2obPB1HiVsFMYfbHEIb4MPsnPRnSGavYHTxt34mHbRsS8BvoBy3v6VNYaewLr6yz-_Zstrnr4I_wxtYbSiPJUeVQHcD-a9Ck53BdjspnhVHZ4IFVvuNrpflVaB1A7P3A2xZ7G_a8gF_SHMynYSA","expires_in":0,"token_type":""}

#. The source application redirects the user to the jump url with the session token in the URL
   First retrieve the jump URL:

   .. code-block:: console

     $ curl --location --request GET 'localhost:1323/api/endpoints?orgIds=urn:oid:2.16.840.1.113883.2.4.6.1:00000001&type=urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-sso-jump-endpoint'

     [{
          "URL": "http://sso.nootenboom.local",
          "endpointType": "urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-sso-jump-endpoint",
          "identifier": "a5c4afba-1393-48dc-b506-e0b6cc969094",
          "status": "active",
          "version": "0.1.0"
      }]

   And then redirect the user:

   .. code-block:: http

      HTTP/1.1 302 Found
      Location: http://sso.nootenboom.local?session_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

#. The destination Authorization Server performs all the checks:

   #. Retrieve the session token from the access token: `rfc7662 <https://tools.ietf.org/html/rfc7662>`_ (This endpoint has yet to be implemented)
   #. Validate the identity from the session using the validate endpoint in Nuts Auth

#. The destination Authorization Server creates an internal URL and session and redirects the user
#. The destination application shows the page with the client context from the session token


Endpoints
=========

The an registry endpoint should use the following for the Nuts OAuth authorization server
::

  urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-oauth-authentication-server

And the following type for the nuts SSO jump endpoint
::

  urn:ietf:rfc:3986:urn:oid:1.3.6.1.4.1.54851.1:nuts-sso-jump-endpoint

Jump
====

The user gets a status 302 or 303 with the jump sso url including the session token.

.. code-block:: http

  HTTP/1.1 302 Found
  Location: https://auth.destination-application.nl?session_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c


TODO
****

Determine which IRMA attributes are needed.

Do we need a separate Jump contract?

Error handling

Specify the contents of the session token

The access token should be opaque to the source application. In a stateless token (the current implementation of the Nuts node) the token is a JWT containing the BSN of the subject. The token should be encrypted. This is currently not the case. This is fine for DEMO purposes, but should be fixed for production. Since the token is used in a GET request, it can be recorded by the browser and the server logs.
